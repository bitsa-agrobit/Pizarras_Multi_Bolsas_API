# ===== Stage 1: build runtime =====
FROM python:3.11-slim AS base

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1

# Paquetes del sistema que necesita Playwright/Chromium
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates curl wget gnupg \
    libnss3 libatk-bridge2.0-0 libatspi2.0-0 \
    libdrm2 libgbm1 libasound2 libxkbcommon0 \
    libgtk-3-0 libxcomposite1 libxdamage1 libxfixes3 \
    libxrandr2 libpango-1.0-0 libcairo2 fonts-liberation \
    && rm -rf /var/lib/apt/lists/*

# Dependencias que requiere Oracle Instant Client (modo thick)
RUN set -eux; \
    apt-get update; \
    # resolver el nombre correcto de libaio según la distro: libaio1 o libaio1t64
    if apt-cache show libaio1 > /dev/null 2>&1; then \
        AIOPKG=libaio1; \
    else \
        AIOPKG=libaio1t64; \
    fi; \
    apt-get install -y --no-install-recommends "$AIOPKG" libnsl2 ca-certificates; \
    rm -rf /var/lib/apt/lists/*

RUN set -eux; \
    apt-get update; \
    if apt-cache show libaio1 > /dev/null 2>&1; then AIOPKG=libaio1; else AIOPKG=libaio1t64; fi; \
    apt-get install -y --no-install-recommends "$AIOPKG" libnsl2 libstdc++6 libgcc-s1 ca-certificates; \
    rm -rf /var/lib/apt/lists/*

# ===== Stage 2: app =====
FROM base AS app

WORKDIR /app

# requirements primero (mejor cache)
COPY app/requirements.txt /app/requirements.txt
RUN pip install --upgrade pip && pip install -r /app/requirements.txt

# Instalar Chromium para Playwright (y sus deps en la imagen slim)
RUN python -m playwright install --with-deps chromium

# Copiamos el código
COPY app/ /app/

# Puerto interno de la API
EXPOSE 8000

# Variables de entorno (ajustalas en producción / compose / App Service)
# ENV ORACLE_DSN=host:1521/servicio
# ENV ORACLE_USER=usuario
# ENV ORACLE_PASS=secreto

# Entrypoint
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]

